    <#
        .SYNOPSIS
            Download detected and deleted malware metadata to a CSV file.

        .DESCRIPTION
            Export Detected and Deleted Malware Removal data via the Carbon Black API. 
            Please note that the REST API Endpoint used for the data extraction is not 
            officially supported by VMware Carbon Black.

            This script requires a "View All" API key. To configure the the API Key complete the following steps:
            1. From the PSC Console, select Settings, API Access and click the Add API Key button to 
               open the Add API Key dialogue box and enter:
                   a.	Name: <Enter a name for the API Key>
                   b.	Description: <optional, but it is recommended to record the purpose of the credential, who can use it, when they can use it and an expiry.
                   c.	Access Level Type: Custom
                   d.	Custom Access Level: View All
            2.	Click Save

        .PARAMETER -a
            Download malware detection and deletions.
        .PARAMETER -d
            Download malware delections.
        .PARAMETER -l
            Download malware detections.

        .EXAMPLE
            download_malwaremeta.ps1 -base_url prod05 -apiid myapiid -apisecret myapisecret -a
    #>



[CmdletBinding()]


Param(
    # Download detections and deletions
    [Parameter(Mandatory=$false)][switch]$a,

    # Download malware deletions
    [Parameter(Mandatory=$false)][switch]$d,

    # Download malware detections
    [Parameter(Mandatory=$false)][switch]$l,
    
    # The base URL for your PSC environment.
    [Parameter(Mandatory=$true,ParameterSetName = 'ByBaseURL')]
    [ValidateSet('eap01','prod01','prod02','prod05','prod06','eu','nrt')]
    [String]$base_url,

    # Organization ID
    [Parameter(Mandatory=$true)][Int]$orgid,

    # API ID
    [Parameter(Mandatory=$true)][String]$apiid,

    # API Secret Key
    [Parameter(Mandatory=$true)][String]$apisecret

)

function Get-Results {
    
    $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
    $headers.Add("X-Auth-Token", $apisecret + "/" + $apiid)
    $headers.Add("Content-Type", "application/json")

    $body = "{
    `	`"version`":1,
    `	`"fromRow`":1,
    `	`"maxRows`":200,
    `	`"searchWindow`":`"ALL`",
    `	`"criteria`":{`"STATUS`":[`"$status`"]},
    `	`"orgId`":$orgid
    `}"


    $url = "https://defense-$($base_url).conferdeploy.net/appservices/v5/orgs/$($orgid)/binary/knownbad"

    $response = Invoke-RestMethod $url -Method 'POST' -Headers $headers -Body $body

    Write-Output "Saving to $($status)_MALWARE.csv"
    $response.entries | Export-Csv "$($status)_MALWARE.csv" -NoTypeInformation
}


if ($d.IsPresent) {
    $status = "DELETED"
    Get-Results
}

if ($l.IsPresent) {
    $status = "DETECTED"
    Get-Results
}

if ($a.IsPresent) {
    $status = "DELETED"
    Get-Results
    $status = "DETECTED"
    Get-Results
}

# If no download parameter is specified, download deleted and detected meta-data
if (($d -eq $false) -and ($l -eq $false) -and ($a -eq $false)) {
    $status = "DELETED"
    Get-Results
    $status = "DETECTED"
    Get-Results
}
